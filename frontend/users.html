<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/main.css">
</head>
<body>

    <!-- Sidebar: Populated by js/main.js -->
    <nav id="sidebar-nav" class="nav flex-column"></nav>

    <!-- Main Content -->
    <main id="main-page-content">
        <div id="notifications" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

        <div class="card p-3 mb-4 shadow-sm">
            <h2 class="h4" id="form-title">Add New User</h2>
            <form id="user-form">
                <input type="hidden" id="user_id" name="user_id">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" name="email" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="display_name" class="form-label">Display Name</label>
                        <input type="text" id="display_name" name="display_name" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="role" class="form-label">Access Level</label>
                        <select id="role" name="role" class="form-select" required>
                            <option value="user">User</option>
                            <option value="administrator">Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success">Save User</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary d-none">Cancel Edit</button>
                </div>
            </form>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="h4 mb-3">Current Users</h2>
                <table id="users-table" class="table table-striped table-bordered table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Display Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        // No more localStorage or authHeader!
        const form = document.getElementById('user-form');
        const tableBody = document.querySelector('#users-table tbody');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const userIdInput = document.getElementById('user_id');
        const usernameInput = document.getElementById('username');

        async function fetchUsers() {
            try {
                const response = await fetch('/api/users'); // No headers needed
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         alert('Your session has expired. Please log in again.');
                         window.location.href = '/';
                         return;
                    }
                    throw new Error('Failed to load users.');
                }
                const users = await response.json();
                tableBody.innerHTML = '';
                users.forEach(u => {
                    const row = tableBody.insertRow();
                    row.dataset.user = JSON.stringify(u);
                    row.innerHTML = `
                        <td>${u.username}</td>
                        <td>${u.display_name}</td>
                        <td>${u.email}</td>
                        <td>${u.role}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-btn">Edit</button>
                            <button class="btn btn-sm btn-warning reset-btn">Reset Pass</button>
                            <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                        </td>
                    `;
                });
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function resetForm() {
            form.reset();
            userIdInput.value = '';
            usernameInput.disabled = false;
            formTitle.textContent = 'Add New User';
            cancelBtn.classList.add('d-none');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = userIdInput.value;
            const url = userId ? `/api/users/${userId}` : '/api/users';
            const method = userId ? 'PUT' : 'POST';

            const body = new URLSearchParams(new FormData(form));
            if(method === 'PUT') body.delete('username');

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to save user.');
                }
                showNotification(`User ${userId ? 'updated' : 'created'} successfully!`);
                resetForm();
                fetchUsers();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        });

        tableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;
            const userData = JSON.parse(row.dataset.user);

            if (target.classList.contains('edit-btn')) {
                formTitle.textContent = `Edit User: ${userData.username}`;
                userIdInput.value = userData.id;
                usernameInput.value = userData.username;
                usernameInput.disabled = true; // Can't change username
                document.getElementById('email').value = userData.email;
                document.getElementById('display_name').value = userData.display_name;
                document.getElementById('role').value = userData.role;
                cancelBtn.classList.remove('d-none');
                window.scrollTo(0, 0);
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm(`Are you sure you want to delete user ${userData.username}?`)) {
                    try {
                        const response = await fetch(`/api/users/${userData.id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.detail || 'Failed to delete user.');
                        }
                        showNotification('User deleted successfully!');
                        fetchUsers();
                    } catch (error) {
                        showNotification(error.message, 'error');
                    }
                }
            }

            if (target.classList.contains('reset-btn')) {
                if (confirm(`Reset password for ${userData.username}? The new password will be their username.`)) {
                    try {
                        const response = await fetch(`/api/users/${userData.id}/reset_password`, {
                            method: 'POST'
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.detail || 'Failed to reset password.');
                        }
                        showNotification('Password reset successfully!');
                    } catch (error) {
                        showNotification(error.message, 'error');
                    }
                }
            }
        });

        cancelBtn.addEventListener('click', resetForm);
        // On page load, just fetch the data. The server has already verified admin access.
        document.addEventListener('DOMContentLoaded', () => {
            initializePage(fetchUsers);
        });
    </script>
</body>
</html>