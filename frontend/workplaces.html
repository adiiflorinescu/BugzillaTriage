<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace View</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/main.css">
</head>
<body>

    <!-- Sidebar: Populated by js/main.js -->
    <nav id="sidebar-nav" class="nav flex-column"></nav>

    <!-- Main Content -->
    <main id="main-page-content">
        <div id="notifications" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

        <div class="card p-3 mb-4 shadow-sm">
            <h2 class="h5">Filters</h2>
            <form id="filter-form" class="row g-2 align-items-end">
                <div class="col">
                    <label for="search-input" class="form-label">Search Bugs</label>
                    <input type="search" id="search-input" class="form-control" placeholder="Search across all columns...">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <button type="button" id="reset-filter-btn" class="btn btn-secondary">Reset</button>
                </div>
            </form>
        </div>

        <div id="loading-card" class="card p-4 text-center shadow-sm">
            <div class="spinner-border text-primary mx-auto" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Loading Bugs...</p>
        </div>
        
        <div id="sections-container"></div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        const tableHead = document.querySelector('#bugs-table thead');
        const loadingCard = document.getElementById('loading-card');
        const filterForm = document.getElementById('filter-form');
        const searchInput = document.getElementById('search-input');
        const sectionsContainer = document.getElementById('sections-container');

        const BUGZILLA_URL = "https://bugzilla.mozilla.org";

        async function renderWorkplaceBugs() {
            // Get the workplace ID from the URL path
            const pathParts = window.location.pathname.split('/');
            const workplaceId = pathParts[pathParts.length - 1];

            if (!workplaceId || isNaN(workplaceId)) {
                document.getElementById('main-page-title').textContent = "Invalid Workplace";
                loadingCard.classList.add('d-none');
                showNotification("Could not determine the workplace from the URL.", "error");
                return;
            }

            try {
                const response = await fetch(`/api/workplaces/${workplaceId}/view`);
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         alert('Your session has expired. Please log in again.');
                         window.location.href = '/';
                         return;
                    }
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to load workplace data.');
                }
                const data = await response.json();

                // Update the dynamically created H1 tag
                document.getElementById('main-page-title').textContent = `Workplace: ${data.workplace_name}`;
                document.title = `Workplace: ${data.workplace_name}`; // Update page title

                sectionsContainer.innerHTML = ''; // Clear previous content

                if (data.sections.length === 0) {
                    sectionsContainer.innerHTML = '<div class="card shadow-sm"><div class="card-body text-center text-muted">No queries or bugs found for this workplace.</div></div>';
                } else {
                    data.sections.forEach(section => {
                        const sectionHtml = `
                            <div class="card shadow-sm mb-4">
                                <div class="card-header">
                                    <h3 class="h5 mb-0">${section.query_name}</h3>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered table-hover mb-0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Bug ID</th>
                                                    <th title="Last updated"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg></th>
                                                    <th>xn</th>
                                                    <th>3</th>
                                                    ${data.columns.map(colName => `<th>${colName}</th>`).join('')}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${renderBugRows(section.bugs, data.columns)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                        sectionsContainer.insertAdjacentHTML('beforeend', sectionHtml);
                    });
                }

                loadingCard.classList.add('d-none');
            } catch (error) {
                showNotification(error.message, 'error');
                document.getElementById('main-page-title').textContent = "Error Loading Workplace";
                loadingCard.classList.add('d-none');
            }
        }

        function renderBugRows(bugs, columns) {
            if (bugs.length === 0) {
                return `<tr><td colspan="${columns.length + 4}" class="text-center text-muted">No bugs found for this query.</td></tr>`;
            }
            return bugs.map(bug => {
                const { relativeTime, tooltip } = formatRelativeTime(bug.last_updated);
                const workplaceCount = bug.workplaces.length;
                const workplaceTooltip = `Present in: ${bug.workplaces.map(wp => wp[1]).join(', ')}`;

                return `
                    <tr class="bug-row">
                        <td><a href="${BUGZILLA_URL}/show_bug.cgi?id=${bug.bug_id}" target="_blank">${bug.bug_id}</a></td>
                        <td title="${tooltip}">${relativeTime}</td>
                        <td title="${workplaceTooltip}">x${workplaceCount}</td>
                        <td></td>
                        ${columns.map(colName => `<td>${bug[colName] !== null && bug[colName] !== undefined ? bug[colName] : 'N/A'}</td>`).join('')}
                    </tr>
                `;
            }).join('');
        }

        function formatRelativeTime(isoString) {
            if (!isoString) return { relativeTime: 'N/A', tooltip: 'No update time available' };

            const now = new Date();
            const updatedTime = new Date(isoString);
            const diffSeconds = Math.round((now - updatedTime) / 1000);
            const diffMinutes = Math.round(diffSeconds / 60);
            const diffHours = Math.round(diffMinutes / 60);
            const diffDays = Math.round(diffHours / 24);

            if (diffSeconds < 60) {
                return { relativeTime: '<1m', tooltip: `Last updated ${diffSeconds} seconds ago` };
            } else if (diffMinutes < 60) {
                return { relativeTime: '<1h', tooltip: `Last updated ${diffMinutes} minutes ago` };
            } else if (diffHours < 24) {
                return { relativeTime: `<${diffHours}h`, tooltip: `Last updated ${diffHours} hours ago` };
            } else {
                return { relativeTime: `>${diffDays}d`, tooltip: `Last updated ${diffDays} days ago` };
            }
        }

        function handleFilter() {
            const searchTerm = searchInput.value.toLowerCase();
            const allRows = document.querySelectorAll('.bug-row');

            allRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleFilter();
        });

        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            searchInput.value = '';
            handleFilter();
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializePage(renderWorkplaceBugs, "Loading Workplace...");
        });
    </script>
</body>
</html>