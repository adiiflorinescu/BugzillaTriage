<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Workplaces</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/main.css">
</head>
<body>

    <!-- Sidebar: Populated by js/main.js -->
    <nav id="sidebar-nav" class="nav flex-column"></nav>

    <!-- Main Content -->
    <main id="main-page-content">
        <div id="notifications" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

        <div class="collapse" id="create-workplace-section">
            <div class="card card-body mb-4 shadow-sm">
                <h2 class="h4" id="form-title">Create New Workplace</h2>
            <form id="workplace-form">
                <input type="hidden" id="workplace_id" name="workplace_id">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="name" class="form-label">Workplace Name</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                </div>

                <hr class="my-4">

                <h3 class="h5">
                     <a data-bs-toggle="collapse" href="#columns-section" role="button" aria-expanded="false" aria-controls="columns-section" class="text-decoration-none" id="column-config-header">
                        Column Configuration
                    </a>
                </h3>
                <div class="collapse" id="columns-section">
                    <div id="columns-grid" class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Column</th>
                                    <th class="text-center">Default Visibility</th>
                                </tr>
                            </thead>
                            <tbody><!-- Populated by JS --></tbody>
                        </table>
                    </div>
                </div>

                <hr class="my-4">

                <h3 class="h5">
                    <a data-bs-toggle="collapse" href="#users-section" role="button" aria-expanded="false" aria-controls="users-section" class="text-decoration-none" id="user-access-header">
                        User Access
                    </a>
                </h3>
                <div class="collapse" id="users-section">
                    <div id="users-grid" class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Username</th>
                                    <th class="text-center">Has Access</th>
                                </tr>
                            </thead>
                            <tbody><!-- Populated by JS --></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success">Save Workplace</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary d-none">Cancel Edit</button>
                </div>
            </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Current Workplaces</h2>
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#create-workplace-section" aria-expanded="false" aria-controls="create-workplace-section" id="toggle-create-btn">
                    Create New Workplace
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="workplaces-table" class="table table-striped table-bordered table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Visible Columns</th>
                            <th>User Access</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
            <div class="card-footer text-center" style="display: none;" id="load-more-workplaces">
                <button class="btn btn-secondary">Load More</button>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        const form = document.getElementById('workplace-form');
        const loadMoreBtn = document.getElementById('load-more-workplaces');
        if(loadMoreBtn) {
            loadMoreBtn.addEventListener('click', fetchAndRenderWorkplaces);
        }
        const tableBody = document.querySelector('#workplaces-table tbody');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const createBtn = document.getElementById('toggle-create-btn');
        const createSection = document.getElementById('create-workplace-section');
        const workplaceIdInput = document.getElementById('workplace_id');
        const nameInput = document.getElementById('name');
        const columnsGridBody = document.querySelector('#columns-grid tbody');
        const usersGridBody = document.querySelector('#users-grid tbody');

        let allColumns = [];
        let allUsers = [];

        let workplaceSkip = 0;
        const workplaceLimit = 50; // Load 50 workplaces at a time

        async function fetchInitialData() {
            try {
                const [columnsRes, usersRes] = await Promise.all([
                    fetch('/api/columns'),
                    fetch('/api/users')
                ]);

                if (!columnsRes.ok || !usersRes.ok) {
                    if ([401, 403].includes(columnsRes.status) || [401, 403].includes(usersRes.status)) {
                        alert('Your session has expired. Please log in again.');
                        window.location.href = '/';
                    }
                    throw new Error('Failed to load initial config data.');
                }

                allColumns = await columnsRes.json();
                allUsers = await usersRes.json();
                // Initial load is handled by fetchAndRenderWorkplaces

                // Populate the configuration grids in the form
                renderConfigGrids();
                updateUserAccessHeader();
                updateColumnConfigHeader();

                // Populate workplaces table
                tableBody.innerHTML = ''; // Clear table for new session
                workplaceSkip = 0; // Reset pagination
                await fetchAndRenderWorkplaces();

            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        async function fetchAndRenderWorkplaces() {
            try {
                const workplacesRes = await fetch(`/api/workplaces?skip=${workplaceSkip}&limit=${workplaceLimit}`);
                if (!workplacesRes.ok) throw new Error("Failed to load workplaces");
                const workplaces = await workplacesRes.json();

                workplaces.forEach(wp => {
                    const row = tableBody.insertRow();
                    row.dataset.workplace = JSON.stringify(wp);
                    const isStatic = wp.name === 'My Dashboard';

                    // Calculate counts for the new columns
                    const visibleColsCount = wp.columns.filter(c => c.is_visible).length;
                    const totalColsCount = allColumns.length;
                    const userAccessCount = wp.users.length;
                    const totalUsersCount = allUsers.length;

                    row.innerHTML = `
                        <td>${wp.name}</td>
                        <td>${visibleColsCount} / ${totalColsCount}</td>
                        <td>${userAccessCount} / ${totalUsersCount}</td>
                        <td>
                            <a href="/workplaces/${wp.id}" class="btn btn-sm btn-info">View</a>
                            ${!isStatic ? `<button class="btn btn-sm btn-primary edit-btn">Edit</button>
                                          <button class="btn btn-sm btn-danger delete-btn">Delete</button>` : '<span>Static</span>'}
                        </td>
                    `;
                });

                // Handle "Load More" button
                const loadMoreBtn = document.getElementById('load-more-workplaces');
                if (workplaces.length < workplaceLimit) {
                    if(loadMoreBtn) loadMoreBtn.style.display = 'none'; // Hide if no more data
                } else {
                    if(loadMoreBtn) loadMoreBtn.style.display = 'block'; // Show if more data might exist
                    workplaceSkip += workplaceLimit;
                }
            } catch(error) {
                 showNotification(error.message, 'error');
            }
        }

        function renderConfigGrids() {
            columnsGridBody.innerHTML = '';
            allColumns.forEach(col => {
                columnsGridBody.innerHTML += `
                    <tr>
                        <td>${col.name}</td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input column-visibility" data-column-id="${col.id}" checked>
                        </td>
                    </tr>
                `;
            });

            usersGridBody.innerHTML = '';
            allUsers.forEach(user => {
                usersGridBody.innerHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input user-access" data-user-id="${user.id}" checked>
                        </td>
                    </tr>
                `;
            });
        }

        function updateUserAccessHeader() {
            const header = document.getElementById('user-access-header');
            if (!header) return;

            const totalUsers = allUsers.length;
            const checkedUsers = document.querySelectorAll('.user-access:checked').length;

            header.textContent = `User Access (${checkedUsers}/${totalUsers})`;
        }

        function updateColumnConfigHeader() {
            const header = document.getElementById('column-config-header');
            if (!header) return;

            const totalColumns = allColumns.length;
            const checkedColumns = document.querySelectorAll('.column-visibility:checked').length;

            header.textContent = `Column Configuration (${checkedColumns}/${totalColumns})`;
        }

        function resetForm() {
            form.reset();
            workplaceIdInput.value = '';
            formTitle.textContent = 'Create New Workplace';
            cancelBtn.classList.add('d-none');
            // Reset all checkboxes to checked (default state for creation)
            document.querySelectorAll('.column-visibility').forEach(cb => cb.checked = true);
            document.querySelectorAll('.user-access').forEach(cb => cb.checked = true);
            bootstrap.Collapse.getOrCreateInstance(createSection).hide();
            updateColumnConfigHeader();
            updateUserAccessHeader();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const workplaceId = workplaceIdInput.value;
            const url = workplaceId ? `/api/workplaces/${workplaceId}` : '/api/workplaces';
            const method = workplaceId ? 'PUT' : 'POST';

            const columnConfigs = Array.from(document.querySelectorAll('.column-visibility')).map(cb => {
                return { id: parseInt(cb.dataset.columnId), visible: cb.checked };
            });

            const userAccess = Array.from(document.querySelectorAll('.user-access:checked')).map(cb => parseInt(cb.dataset.userId));

            const body = new FormData();
            body.append('name', nameInput.value);
            body.append('columns', JSON.stringify(columnConfigs));
            userAccess.forEach(id => body.append('users', id));

            try {
                const response = await fetch(url, {
                    method: method,
                    body: body
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to save workplace.');
                }
                showNotification(`Workplace ${workplaceId ? 'updated' : 'created'} successfully!`);
                resetForm();
                await fetchInitialData(); // Re-fetch all data to ensure UI is consistent
            } catch (error) {
                showNotification(error.message, 'error');
            }
        });

        tableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;
            const workplaceData = JSON.parse(row.dataset.workplace);

            if (target.classList.contains('edit-btn')) {
                formTitle.textContent = `Edit Workplace: ${workplaceData.name}`;
                workplaceIdInput.value = workplaceData.id;
                nameInput.value = workplaceData.name;

                // Set column visibility checkboxes
                const visibleCols = new Set(workplaceData.columns.filter(c => c.is_visible).map(c => c.column_id));
                document.querySelectorAll('.column-visibility').forEach(cb => {
                    cb.checked = visibleCols.has(parseInt(cb.dataset.columnId));
                });

                // Set user access checkboxes
                const accessibleUsers = new Set(workplaceData.users);
                document.querySelectorAll('.user-access').forEach(cb => {
                    cb.checked = accessibleUsers.has(parseInt(cb.dataset.userId));
                });
                updateUserAccessHeader();
                updateColumnConfigHeader();
                bootstrap.Collapse.getOrCreateInstance(createSection).show();

                cancelBtn.classList.remove('d-none');
                window.scrollTo(0, 0);
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm(`Are you sure you want to delete workplace "${workplaceData.name}"?`)) {
                    try {
                        const response = await fetch(`/api/workplaces/${workplaceData.id}`, { method: 'DELETE' });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.detail || 'Failed to delete workplace.');
                        }
                        showNotification(`Workplace "${workplaceData.name}" deleted successfully!`);
                        fetchInitialData();
                    } catch (error) {
                        showNotification(error.message, 'error');
                    }
                }
            }
        });

        createBtn.addEventListener('click', () => {
            // If the form is in edit mode (has a workplace ID), clicking "Create" should
            // reset it to a clean state.
            const isEditMode = !!workplaceIdInput.value;
            if (isEditMode) {
                resetForm();
                // Since resetForm() hides the section, we need to re-show it.
                bootstrap.Collapse.getOrCreateInstance(createSection).show();
            }
        });

        usersGridBody.addEventListener('change', updateUserAccessHeader);
        columnsGridBody.addEventListener('change', updateColumnConfigHeader);

        cancelBtn.addEventListener('click', resetForm);
        document.addEventListener('DOMContentLoaded',  () => {
            initializePage(fetchInitialData);
        });
    </script>
</body>
</html>