<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Execution Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/main.css">
    <style>
        .table-responsive { overflow-x: auto; }
    </style>
</head>
<body>

    <!-- Sidebar: Populated by js/main.js -->
    <nav id="sidebar-nav" class="nav flex-column"></nav>

    <!-- Main Content -->
    <main id="main-page-content">
        <div id="notifications" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

        <!-- Automatic Queries Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">All Queries</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="queries-table" class="table table-striped table-bordered table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Name</th>
                                <th>Frequency</th>
                                <th>Last Execution</th>
                                <th>Next Execution</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Execution History for...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="history-modal-body-content" class="table-responsive">
                        <!-- History table will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        const queriesTableBody = document.querySelector('#queries-table tbody');
        let currentUserRole = 'user'; // Default role
        let historyModal; // To hold the modal instance

        function formatDateTime(dateString) {
            // If the date string from the backend is null or undefined, return null.
            if (!dateString) return null;

            // Create a new Date object from the ISO string (e.g., "2023-11-21T15:30:00Z").
            // JavaScript's Date object automatically understands the UTC format.
            const date = new Date(dateString);

            // Use toLocaleString() to format the date. This method automatically uses the
            // user's local timezone and locale settings from their browser/OS.
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function getFrequencyText(query) {
            if (query.frequency_interval_hours) {
                return `Every ${query.frequency_interval_hours}h`;
            }
            return 'Manual';
        }

        function renderTables(queries) {
            queriesTableBody.innerHTML = '';

            if (queries.length === 0) {
                queriesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No queries found.</td></tr>';
            } else {
                queries.forEach(q => renderRow(q, queriesTableBody));
            }
        }

        function renderRow(q, tableBody) {
            const row = tableBody.insertRow();
            // Use the updated formatDateTime function
            const lastExec = formatDateTime(q.last_executed_at) || 'Never executed';
            const nextExec = q.frequency_interval_hours ? (formatDateTime(q.next_execution_at) || 'Not Scheduled') : 'Manual';

            const editButton = currentUserRole === 'administrator'
                ? `<a href="/queries.html#edit-${q.id}" class="btn btn-sm btn-secondary ms-1">Edit</a>`
                : '';

            row.innerHTML = `
                <td>${q.name}</td>
                <td>${getFrequencyText(q)}</td>
                <td>${lastExec}</td>
                <td>${nextExec}</td>
                <td>
                    <button class="btn btn-sm btn-primary execute-btn" data-id="${q.id}">Execute Now</button>
                    <button class="btn btn-sm btn-info history-btn" data-bs-toggle="modal" data-bs-target="#historyModal" data-query-id="${q.id}" data-query-name="${q.name}">History</button>
                    ${editButton}
                </td>
            `;
        }

        async function fetchAndRenderQueries() {
            try {
                const response = await fetch('/api/queries');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         alert('Your session has expired. Please log in again.');
                         window.location.href = '/';
                         return;
                    }
                    throw new Error('Failed to load queries.');
                }
                const queries = await response.json();
                renderTables(queries);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function showHistoryModal(queryId, queryName) {
            const modalTitle = document.getElementById('historyModalLabel');
            const modalBody = document.getElementById('history-modal-body-content');

            modalTitle.textContent = `Execution History for "${queryName}"`;
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</div>';

            try {
                const response = await fetch(`/api/queries/${queryId}/history`);
                if (!response.ok) {
                    throw new Error('Failed to load execution history.');
                }
                const logs = await response.json();

                if (logs.length === 0) {
                    modalBody.innerHTML = '<p class="text-center text-muted">No execution history found for this query.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Execution Time</th>
                                <th>Total Bugs</th>
                                <th>Updated Bugs</th>
                                <th>New Bugs</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => `
                                <tr>
                                    <td>${formatDateTime(log.executed_at)}</td>
                                    <td>${log.total_bugs_processed}</td>
                                    <td>${log.existing_bugs_updated}</td>
                                    <td>${log.new_bugs_added}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
                modalBody.innerHTML = tableHTML;
            } catch (error) {
                modalBody.innerHTML = `<p class="text-center text-danger">${error.message}</p>`;
            }
        }

        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('execute-btn')) {
                const queryId = e.target.dataset.id;
                e.target.disabled = true;
                e.target.textContent = 'Executing...';

                try {
                    const response = await fetch(`/api/queries/${queryId}/execute`, { method: 'POST' });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Execution failed.');
                    }
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    // Refresh the data after a short delay to allow the backend to update
                    setTimeout(fetchAndRenderQueries, 2000);
                } catch (error) {
                    showNotification(error.message, 'error');
                } finally {
                    e.target.disabled = false;
                    e.target.textContent = 'Execute Now';
                }
            }

            if (e.target.classList.contains('history-btn')) {
                const queryId = e.target.dataset.queryId;
                const queryName = e.target.dataset.queryName;
                showHistoryModal(queryId, queryName);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            initializePage(async (user) => {
                currentUserRole = user.role;
                await fetchAndRenderQueries();
            });
        });
    </script>
</body>
</html>