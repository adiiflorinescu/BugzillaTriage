<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugzilla Tracker</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #notifications { position: fixed; top: 1rem; right: 1rem; z-index: 1050; }
        .toast { min-width: 250px; }
        .admin-link { display: none; } /* Hide admin links by default */
    </style>
</head>
<body class="bg-light">

    <!-- Notification container -->
    <div id="notifications" class="toast-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-4">Bugzilla Tracker</h1>
            <div id="user-info" class="text-end">
                <!-- User info or login form will go here -->
            </div>
        </div>

        <div id="loading-card" class="card p-4 text-center shadow-sm">
            <div class="spinner-border text-primary mx-auto" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Loading Application...</p>
        </div>

        <div id="login-card" class="card p-3 mb-4 shadow-sm d-none">
             <h2 class="h4">Login</h2>
             <form id="login-form">
                 <div class="row g-2 align-items-end">
                     <div class="col">
                         <label for="username" class="form-label">Username</label>
                         <input type="text" id="username" name="username" class="form-control" required>
                     </div>
                     <div class="col">
                         <label for="password" class="form-label">Password</label>
                         <input type="password" id="password" name="password" class="form-control" required>
                     </div>
                     <div class="col-auto">
                         <button type="submit" class="btn btn-primary">Login</button>
                     </div>
                 </div>
             </form>
         </div>


        <div id="main-content" class="d-none">
            <div class="card p-3 mb-4 shadow-sm">
                <div class="d-flex flex-wrap justify-content-start align-items-center gap-3">

                    <a href="/execution.html" class="btn btn-primary">Execution Status</a>

                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" id="workplaces-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Workplaces
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="workplaces-dropdown" id="workplaces-menu">
                            <!-- Workplace links will be inserted here -->
                        </ul>
                    </div>

                    <div class="admin-controls">
                        <a href="/columns.html" class="btn btn-secondary admin-link">Configure Columns</a>
                        <a href="/queries.html" class="btn btn-info admin-link">Configure Queries</a>
                        <a href="/users.html" class="btn btn-warning admin-link">User Management</a>
                        <a href="/manage-workplaces.html" class="btn btn-dark admin-link">Manage Workplaces</a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="h4">Welcome to the Bugzilla Tracker</h2>
                    <p class="text-muted">
                        Use the navigation buttons above to get started.
                    </p>
                    <ul>
                        <li>
                            <strong>Execution Status:</strong> View all saved queries, see their last execution time, and run them manually.
                        </li>
                        <li>
                            <strong>Workplaces:</strong> View a dashboard of bugs based on the last execution of the queries in that workplace.
                        </li>
                        <li>
                            <strong>Admin Controls (for administrators):</strong> Configure columns, queries, users, and workplaces.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const loginForm = document.getElementById('login-form');
        const loginCard = document.getElementById('login-card');
        const mainContent = document.getElementById('main-content');
        const userInfoDiv = document.getElementById('user-info');
        const loadingCard = document.getElementById('loading-card');
        const workplacesMenu = document.getElementById('workplaces-menu');

        function showNotification(message, type = 'success') {
            const notificationsContainer = document.getElementById('notifications');
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${type === 'error' ? 'bg-danger' : 'bg-success'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
                </div>`;
            notificationsContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        }

        function showLoginState() {
            mainContent.classList.add('d-none');
            loadingCard.classList.add('d-none');
            loginCard.classList.remove('d-none');
            userInfoDiv.innerHTML = '';
            document.querySelectorAll('.admin-link').forEach(el => el.style.display = 'none');
        }

        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (!response.ok) throw new Error('Logout failed on the server.');
                showNotification('Logged out successfully.', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                window.location.href = "/";
            }
        }

        async function populateWorkplacesMenu() {
            try {
                const response = await fetch('/api/workplaces');
                if (!response.ok) throw new Error('Could not load workplaces.');
                const workplaces = await response.json();
                workplacesMenu.innerHTML = '';

                const selectableWorkplaces = workplaces.filter(w => w.name !== "My Dashboard");

                if (selectableWorkplaces.length === 0) {
                    workplacesMenu.innerHTML = '<li><span class="dropdown-item-text">No workplaces configured.</span></li>';
                    return;
                }

                selectableWorkplaces.forEach(w => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="dropdown-item" href="/workplaces/${w.id}">${w.name}</a>`;
                    workplacesMenu.appendChild(li);
                });
            } catch (error) {
                workplacesMenu.innerHTML = '<li><span class="dropdown-item-text text-danger">Error loading.</span></li>';
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/users/me');
                if (!response.ok) {
                    showLoginState();
                    return;
                }
                const user = await response.json();
                loadingCard.classList.add('d-none');
                loginCard.classList.add('d-none');
                mainContent.classList.remove('d-none');
                userInfoDiv.innerHTML = `<span>Welcome, <strong>${user.username}</strong> (${user.role})</span> <button id="logout-btn" class="btn btn-sm btn-outline-danger ms-2">Logout</button>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                if (user.role === 'administrator') {
                    document.querySelectorAll('.admin-link').forEach(el => el.style.display = 'inline-block');
                }
                await populateWorkplacesMenu();
            } catch (error) {
                showLoginState();
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = new URLSearchParams(new FormData(loginForm));
            try {
                const response = await fetch('/api/token', { method: 'POST', body: body });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Login failed");
                }
                showNotification('Login successful!', 'success');
                checkLoginStatus();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        });

        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>