<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Configurator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/main.css">
    <style>
        #test-log { max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.875em; }
        .automatic-options { display: none; } /* Hide by default */
    </style>
</head>
<body>

    <!-- Sidebar: Populated by js/main.js -->
    <nav id="sidebar-nav" class="nav flex-column"></nav>

    <!-- Main Content -->
    <main id="main-page-content">
        <div id="notifications" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

        <div class="collapse" id="create-query-section">
            <div class="card card-body mb-4 shadow-sm">
                <h2 class="h4" id="form-title">Add New Query</h2>
            <form id="query-form">
                <input type="hidden" id="query_id" name="query_id">
                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="query_url" class="form-label">Bugzilla Query URL</label>
                    <textarea id="query_url" name="query_url" class="form-control" rows="3" required></textarea>
                </div>
                <!-- Test results log is now part of the form and hidden by default -->
                <div id="test-results-container" class="card shadow-sm mb-3" style="display: none;">
                    <div class="card-body">
                        <h3 class="h6">Test Results</h3>
                        <div id="test-log" class="p-2 bg-dark text-white rounded"></div>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="details" class="form-label">Details</label>
                        <input type="text" id="details" name="details" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="workplace_id" class="form-label">Workplace</label>
                        <select id="workplace_id" name="workplace_id" class="form-select" required></select>
                    </div>
                </div>

                <hr/>
                <h3 class="h5 mt-3">Scheduling</h3>
                <div class="row g-3">
                    <div class="col-md-4 col-lg-3">
                        <label for="frequency_interval_hours" class="form-label">Default Frequency (Hours)</label>
                        <input type="number" id="frequency_interval_hours" name="frequency_interval_hours" class="form-control" min="0.1" step="0.1">
                        <div class="form-text">
                            Set how often this query should run automatically. Leave blank for manual execution only.
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                    <div>
                        <button type="submit" class="btn btn-success">Save Query</button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary d-none">Cancel Edit</button>
                    </div>
                    <button type="button" id="test-btn" class="btn btn-info">Test Query URL</button>
                </div>
            </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Saved Queries</h2>
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#create-query-section" aria-expanded="false" aria-controls="create-query-section" id="toggle-create-btn">
                    Create New Query
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                <table id="queries-table" class="table table-striped table-bordered table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Workplace</th>
                            <th>Frequency</th>
                            <th>Details</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        const form = document.getElementById('query-form');
        const formTitle = document.getElementById('form-title');
        const testBtn = document.getElementById('test-btn');
        const testLog = document.getElementById('test-log');
        const tableBody = document.querySelector('#queries-table tbody');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const queryIdInput = document.getElementById('query_id');
        const createBtn = document.getElementById('toggle-create-btn');
        const createSection = document.getElementById('create-query-section');        
        const frequencyIntervalInput = document.getElementById('frequency_interval_hours');
        const testResultsContainer = document.getElementById('test-results-container');

        let workplaceMap = {};

        async function populateWorkplaces() {
            const workplaceSelect = document.getElementById('workplace_id');
            workplaceSelect.innerHTML = '';
            const response = await fetch('/api/workplaces');
            const workplaces = await response.json();

            workplaceMap = {};
            let selectableWorkplaces = 0;

            workplaces.forEach(w => {
                workplaceMap[w.id] = w.name;
                // "My Dashboard" is not a valid target for queries
                if (w.name !== 'My Dashboard') {
                    const option = new Option(w.name, w.id);
                    workplaceSelect.add(option);
                    selectableWorkplaces++;
                }
            });

            if (selectableWorkplaces === 0) {
                const placeholder = new Option("No workplaces available. Create one first.", "");
                placeholder.disabled = true;
                workplaceSelect.add(placeholder);
            }
        }

        function getFrequencyText(query) {
            // If frequency_interval_hours has a value, it's automatic.
            if (query.frequency_interval_hours) {
                return `Every ${query.frequency_interval_hours}h`;
            }
            return 'Manual';
        }

        async function fetchQueries() {
            try {
                const response = await fetch('/api/queries');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         alert('Your session has expired. Please log in again.');
                         window.location.href = '/';
                         return;
                    }
                    throw new Error('Failed to load queries.');
                }
                const queries = await response.json();
                tableBody.innerHTML = '';
                if (queries.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No queries saved yet.</td></tr>';
                    return;
                }
                queries.forEach(q => {
                    const row = tableBody.insertRow();
                    row.dataset.query = JSON.stringify(q);
                    const workplaceName = workplaceMap[q.workplace_id] || 'N/A';

                    row.innerHTML = `
                        <td>${q.name}</td>
                        <td>${workplaceName}</td>
                        <td>${getFrequencyText(q)}</td>
                        <td>${q.details || ''}</td>
                        <td>
                            <button class="btn btn-primary btn-sm edit-btn">Edit</button>
                            <button class="btn btn-danger btn-sm delete-btn" data-id="${q.id}">Delete</button>
                        </td>
                    `;
                });
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function resetForm() {
            form.reset();
            queryIdInput.value = '';
            formTitle.textContent = 'Add New Query';
            cancelBtn.classList.add('d-none');
            testResultsContainer.style.display = 'none'; // Hide test results on reset
            bootstrap.Collapse.getOrCreateInstance(createSection).hide();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const queryId = queryIdInput.value;
            const url = queryId ? `/api/queries/${queryId}` : '/api/queries';
            const method = queryId ? 'PUT' : 'POST';
            
            const formData = new FormData(form);
            formData.append('frequency_type', formData.get('frequency_interval_hours') ? 'automatic' : 'manual');
            const body = new URLSearchParams(formData);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to save query.');
                }
                showNotification(`Query ${queryId ? 'updated' : 'created'} successfully!`);
                resetForm();
                fetchQueries();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        });

        tableBody.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;

            if (target.classList.contains('edit-btn')) {
                const queryData = JSON.parse(row.dataset.query);
                formTitle.textContent = `Edit Query: ${queryData.name}`;
                queryIdInput.value = queryData.id;
                document.getElementById('name').value = queryData.name;
                document.getElementById('query_url').value = queryData.query_url;
                document.getElementById('details').value = queryData.details;
                document.getElementById('workplace_id').value = queryData.workplace_id;
                frequencyIntervalInput.value = queryData.frequency_interval_hours;
                
                testResultsContainer.style.display = 'none'; // Hide test results when starting an edit
                bootstrap.Collapse.getOrCreateInstance(createSection).show();
                cancelBtn.classList.remove('d-none');
                window.scrollTo(0, 0);
            }

            if (target.classList.contains('delete-btn')) {
                const queryId = e.target.dataset.id;
                if (confirm('Are you sure you want to delete this query?')) {
                    try {
                        const response = await fetch(`/api/queries/${queryId}`, { method: 'DELETE' });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to delete query.');
                        }
                        showNotification('Query deleted.');
                        fetchQueries();
                    } catch (error) {
                        showNotification(error.message, 'error');
                    }
                }
            }
        });

        testBtn.addEventListener('click', async () => {
            const queryUrl = document.getElementById('query_url').value;
            if (!queryUrl) {
                showNotification('Please enter a Query URL to test.', 'error');
                return;
            }
            testLog.innerHTML = 'Testing...';
            testResultsContainer.style.display = 'block'; // Show the results container
            try {
                const body = new URLSearchParams({ query_url: queryUrl });
                const response = await fetch('/api/queries/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Test failed.');
                testLog.innerHTML = `<strong>Success! Found ${result.bug_count} bugs.</strong><br>${result.bug_ids.join(', ')}`;
            } catch (error) {
                testLog.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
                showNotification(error.message, 'error');
            }
        });

        createBtn.addEventListener('click', () => {
            // If the form is in edit mode (has a query ID), clicking "Create" should
            // reset it to a clean state.
            const isEditMode = !!queryIdInput.value;
            if (isEditMode) {
                resetForm();
                bootstrap.Collapse.getOrCreateInstance(createSection).show();
            }
        });

        cancelBtn.addEventListener('click', resetForm);

        document.addEventListener('DOMContentLoaded', () => {
            // Use the global initializePage function from main.js
            // and pass our page-specific setup logic as a callback.
            initializePage(async () => {
                await populateWorkplaces();
                await fetchQueries();
            });
        });
    </script>
</body>
</html>